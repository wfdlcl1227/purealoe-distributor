<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1">

</head>
<body>

<style type='text/css'>
    .embeddedServiceHelpButton .helpButton .uiButton {
        background-color: #005290;
        font-family: "Arial", sans-serif;
    }
    .embeddedServiceHelpButton .helpButton .uiButton:focus {
        outline: 1px solid #005290;
    }

    .embeddedServiceLiveAgentStateChatPlaintextMessageDefaultUI.plaintextContent{
        margin-left: 0px !important;
    }
    .content{
        display: none !important;
    }
    .avatar{
        display: none !important;
    }
    .embeddedServiceLiveAgentQueuePosition.queuePositionWaiting .youAreNextMessage {
        font-size: 20px !important;
    }
    .agentName {
        display: none !important;
    }
    .queuePositionCounter.queuePositionNumber {
        display: none !important;
    }

</style>
<script type='text/javascript' >
    var initESW = function(gslbBaseURL) {
        embedded_svc.settings.buttonId = settings.buttonId;
        embedded_svc.settings.displayHelpButton = false;
        embedded_svc.settings.language = settings.language;
        embedded_svc.settings.enabledFeatures = ['LiveAgent'];
        embedded_svc.settings.entryFeature = 'LiveAgent';
        embedded_svc.settings.extraPrechatFormDetails = settings.extraPrechatFormDetails;
        embedded_svc.settings.extraPrechatInfo = [{
            "entityFieldMaps": [{
              "doCreate":false,
              "doFind":true,
              "fieldName":"Member_Number__c",
              "isExactMatch":true,
              "label":"Member Number"
            }],
            "entityName":"Account",
            "saveToTranscript": "AccountId",
          }];

        embedded_svc.addEventHandler("featureLoaded",
        function() {
            embedded_svc.onHelpButtonClick();
        }); 
                
        embedded_svc.addEventHandler("onChatEstablished", function(data) {
            console.log("onChatEstablished event was fired.  liveAgentSessionKey was " + data.liveAgentSessionKey);
            //need to be set
            //call salesforce api to get the survey url
            //Method： get, URI:/livechatsurvey/{data.liveAgentSessionKey}
        });


        embedded_svc.addEventHandler("onChatEndedByChasitor", function(data) {
            console.log("onChatEndedByChasitor event was fired.  liveAgentSessionKey was " + data.liveAgentSessionKey);

        });
        embedded_svc.addEventHandler("onIdleTimeoutWarningStart", function(data) {
            console.log("onIdleTimeoutWarningStart event was fired.  liveAgentSessionKey was " + data.liveAgentSessionKey);
        });

        embedded_svc.addEventHandler("onIdleTimeoutClear", function(data) {
            console.log("onIdleTimeoutClear event was fired.  liveAgentSessionKey was " + data.liveAgentSessionKey);
        });   

        embedded_svc.addEventHandler("onIdleTimeoutOccurred", function(data) {
            console.log("onIdleTimeoutClear event was fired.  liveAgentSessionKey was " + data.liveAgentSessionKey);
            switch (settings.language) {
                case "zh_CN":
                    showEndingMessage("Are you still there? We will be closing this chat now. Please feel free to contact us again if you need further help. Happy Shopping!");
                    break;
                case "zh_HK":
                    showEndingMessage("Are you still there? We will be closing this chat now. Please feel free to contact us again if you need further help. Happy Shopping!");
                    break;
                default:
                    showEndingMessage("Are you still there? We will be closing this chat now. Please feel free to contact us again if you need further help. Happy Shopping!");               
            }
        });          
         embedded_svc.addEventHandler("afterDestroy", function(data) {
            console.log("afterDestroy event was fired.  liveAgentSessionKey was ");
             //need to be set
            //replace the  survey url that generated in onChatEstablished event callback function
            debugger;
            var targetBtn = event.target.innerText;
            if(targetBtn == 'Contact US' || targetBtn == '联络我们' || targetBtn == '聯絡我們' ){
                window.open("https://hkia.mp.sit.acnhk.com/en_US/contact-us", "_blank"); 
            }


            var surveyURL = "https://sit-hkairportrewards.cs5.force.com/hkairportrewards/survey/runtimeApp.app?invitationId=0KiO00000008SOy&surveyName=chat_feedback&UUID=e676e020-34ac-4892-9497-c9f7cb11ef95";
            var lan = settings.language.replace("_","-");
            surveyURL += "&guestUserLang=" + lan;
            //window.open(surveyURL, "_blank");            
        });                      
	 embedded_svc.addEventHandler("onSettingsCallCompleted", function(data) {
	    console.log("onSettingsCallCompleted event was fired. Agent availability status is " + data.isAgentAvailable ? "online": "offline");
	    if(!data.isAgentAvailable || data.isAgentAvailable == "false"){
		   // document.styleSheets[1].addRule('body > div.modalContainer.sidebarMaximized.layout-docked.embeddedServiceSidebar > div > div > div.activeFeature.hideWhileLoading > div > div > div > div.dialogButtonContainer > button.dialogButton.dialog-button-0.uiButton.embeddedServiceSidebarButton', 'display: none');
	    }
	});
embedded_svc.addEventHandler("onHelpButtonClick", function(data) {
    console.log("onHelpButtonClick event was fired.");
});

embedded_svc.addEventHandler("onChatRequestSuccess", function(data) {
    console.log("onChatRequestSuccess event was fired.  liveAgentSessionKey was " + data.liveAgentSessionKey);
});

embedded_svc.addEventHandler("onChatEstablished", function(data) {
    console.log("onChatEstablished event was fired.  liveAgentSessionKey was " + data.liveAgentSessionKey);
});

embedded_svc.addEventHandler("onChasitorMessage", function(data) {
    console.log("onChasitorMessage event was fired.  liveAgentSessionKey was " + data.liveAgentSessionKey);
});

embedded_svc.addEventHandler("onAgentMessage", function(data) {
    console.log("onAgentMessage event was fired.  liveAgentSessionKey was " + data.liveAgentSessionKey);
});

embedded_svc.addEventHandler("onChatConferenceInitiated", function(data) {
    console.log("onChatConferenceInitiated event was fired.  liveAgentSessionKey was " + data.liveAgentSessionKey);
});

embedded_svc.addEventHandler("onAgentJoinedConference", function(data) {
    console.log("onAgentJoinedConference event was fired.  liveAgentSessionKey was " + data.liveAgentSessionKey);
});

embedded_svc.addEventHandler("onAgentLeftConference", function(data) {
    console.log("onAgentLeftConference event was fired.  liveAgentSessionKey was " + data.liveAgentSessionKey);
});

embedded_svc.addEventHandler("onChatConferenceEnded", function(data) {
    console.log("onChatConferenceEnded event was fired.  liveAgentSessionKey was " + data.liveAgentSessionKey);
});

embedded_svc.addEventHandler("onChatTransferSuccessful", function(data) {
    console.log("onChatTransferSuccessful event was fired.  liveAgentSessionKey was " + data.liveAgentSessionKey);
});


embedded_svc.addEventHandler("onChatEndedByAgent", function(data) {
    console.log("onChatEndedByAgent event was fired.  liveAgentSessionKey was " + data.liveAgentSessionKey);
});

embedded_svc.addEventHandler("onQueueUpdate", function(data) {
    console.log("onQueueUpdate event was fired. liveAgentSessionKey was " + data.liveAgentSessionKey + "and queuePosition was " + data.queuePosition);
	//document.querySelector("body > div.modalContainer.sidebarMaximized.layout-docked.embeddedServiceSidebar > div > div > div.activeFeature.hideWhileLoading > div > div > div > div.waitingStateButtonContainer").append("xxxxxxxxxxxxxxx");
});

embedded_svc.addEventHandler("onConnectionError", function(data) {
    console.log("onConnectionError event was fired.  liveAgentSessionKey was " + data.liveAgentSessionKey);
});

embedded_svc.addEventHandler("onClickSubmitButton", function(data) {
    console.log("onClickSubmitButton event was fired.  liveAgentSessionKey was " + data.liveAgentSessionKey);
});
embedded_svc.addEventHandler("onInviteAccepted", function(data) {
    console.log("onInviteAccepted event was fired.");
});

embedded_svc.addEventHandler("onInviteRejected", function(data) {
    console.log("onInviteRejected event was fired.");
});
	    
	    
        embedded_svc.init(
            settings.myDomainURL,
            settings.communityURL,
            gslbBaseURL,
            settings.orgId,
            settings.eswLiveAgentDeploymentName,
            {
                baseLiveAgentContentURL: settings.baseLiveAgentContentURL,
                deploymentId: settings.deploymentId,
                buttonId: settings.buttonId,
                baseLiveAgentURL: settings.baseLiveAgentURL,
                eswLiveAgentDevName: settings.eswLiveAgentDevName,
                isOfflineSupportEnabled: false
            }
        );

     

    };

    function showEndingMessage(msg){
        var msgParentNode = document.querySelector("body > div.modalContainer.sidebarMaximized.layout-docked.embeddedServiceSidebar > div > div > div.activeFeature.hideWhileLoading > div > div > div.messageArea > ul > li:nth-last-child(1)");
        var newMsgNode = document.querySelector("body > div.modalContainer.sidebarMaximized.layout-docked.embeddedServiceSidebar > div > div > div.activeFeature.hideWhileLoading > div > div > div.messageArea > ul > li:nth-last-child(1) > div.chatContent").cloneNode(true);
        newMsgNode.firstChild.firstChild.innerText = msg;
        msgParentNode.append(newMsgNode);
    }

    function routeButton(){



    	if(document.getElementById("envSelect").value == "Dev"){
			                settings.buttonId = "5731y0000008OO3";//hardcode
			                settings.eswLiveAgentDevName = "EmbeddedServiceLiveAgent_Parent04I1y0000004CEIEA2_17309ffc012"; //hardcode
			                settings.eswLiveAgentDeploymentName = "Live_Chat_Gen_EN";
    	}else{
			if(settings.buttonType == "Luxury Reserve"){
			            switch (settings.language) {
			            case "zh_CN":
			                settings.buttonId = "573O0000000Cb2x";//hardcode
			                settings.eswLiveAgentDevName = "EmbeddedServiceLiveAgent_Parent04IO00000008OQ9MAM_1731266dd3e"; //hardcode
			                settings.eswLiveAgentDeploymentName = "Live_Chat_LUX_SC";
			                //settings.buttonId = "573O0000000Cb2i";//hardcode
			                //settings.eswLiveAgentDevName = "EmbeddedServiceLiveAgent_Parent04IO00000008OPpMAM_1730da480c1"; //hardcode
			                //settings.eswLiveAgentDeploymentName = "Live_Chat_GEN_SC";                    
			                break;
			            case "zh_HK":
			                settings.buttonId = "573O0000000Cb32";//hardcode
			                settings.eswLiveAgentDevName = "EmbeddedServiceLiveAgent_Parent04IO00000008OQEMA2_1731270d8e1"; //hardcode
			                settings.eswLiveAgentDeploymentName = "Live_Chat_LUX_TC";                
			                break;
			            default:
			                settings.buttonId = "573O0000000Cb2s";//hardcode
			                settings.eswLiveAgentDevName = "EmbeddedServiceLiveAgent_Parent04IO00000008OQJMA2_17312735dcb"; //hardcode
			                settings.eswLiveAgentDeploymentName = "Live_Chat_LUX_EN";                
			            }
			        }else{
			            switch (settings.language) {
			            case "zh_CN":
			                //settings.buttonId = "573O0000000Cb2x";//hardcode
			                //settings.eswLiveAgentDevName = "EmbeddedServiceLiveAgent_Parent04IO00000008OQ4MAM_1730da66dc0"; //hardcode
			                //settings.eswLiveAgentDeploymentName = "Live_Chat_Lux_SC";
			                settings.buttonId = "573O0000000Cb2i";//hardcode
			                settings.eswLiveAgentDevName = "EmbeddedServiceLiveAgent_Parent04IO00000008OPpMAM_1730da480c1"; //hardcode
			                settings.eswLiveAgentDeploymentName = "Live_Chat_GEN_SC";                  
			                break;
			            case "zh_HK":
			                settings.buttonId = "573O0000000Cb2n";//hardcode
			                settings.eswLiveAgentDevName = "EmbeddedServiceLiveAgent_Parent04IO00000008OPuMAM_1730da4f18d"; //hardcode
			                settings.eswLiveAgentDeploymentName = "Live_Chat_GEN_TC";  
			                break;
			            default:
			                settings.buttonId = "573O0000000Cb2d";//hardcode
			                settings.eswLiveAgentDevName = "EmbeddedServiceLiveAgent_Parent04IO00000008OPkMAM_1730d97a711"; //hardcode
			                settings.eswLiveAgentDeploymentName = "Live_Chat_GEN_EN";                  
			            }
			    }
    	}


        


    }


    function checkAgentAvailable(){
        var agentAvailable = true;
        //need to do: call live agent API to check agent status with buttonId, need do the proxy by member protal
        /*
        var request = new XMLHttpRequest();
        request.open('GET', "https://t6f2vhju5f.execute-api.ap-southeast-1.amazonaws.com/dev/proxy/chat/rest/Visitor/Availability?Availability.prefix=Visitor&Availability.ids=[5731y0000008OO3]&deployment_id=5721y0000008OMb&org_id=00D1y0000008l0f");
        request.setRequestHeader("Content-type","application/json");
        request.setRequestHeader("X-LIVEAGENT-API-VERSION","29");

        request.send();
        request.onload = function(e){
            console.log(request)

            if (request.status === 200) {
                alert('success');
            }
            else{
                alert('failed');
            }
        }
        request.onerror = function(e){
           debugger;
        }
        */
        if(agentAvailable){
            StartChat();
        }else{
        //need to do: no agent online then redirect to offline contact us page
        }

    }


    var StartChat = function() {

    	if(document.getElementById("envSelect").value == "Dev"){
	        settings = {
	        			env:"Dev",
	                    //language:"zh_CN",//need to be set
	                    channel:"Member Portal", //need to be set
	                    membernumber:"AADEV-0000009230", //need to be set
	                    orgId:"00D1y0000008l0f", //hardcode
	                    deploymentId:"5721y0000008OMb", //hardcode
	                    myDomainURL:"https://hkairportloyalty--dev1.my.salesforce.com", //hardcode
	                    communityURL:"https://dev1-member-portal.cs114.force.com/memberportal", //hardcode
	                    eswJSURL:"https://hkairportloyalty--dev1.my.salesforce.com/embeddedservice/5.0/esw.min.js", //hardcode
	                    gslbBaseURL:"https://service.force.com", //hardcode
	                    baseLiveAgentURL:"https://d.la2-c1cs-hnd.salesforceliveagent.com/chat", //hardcode
	                    baseLiveAgentContentURL:"https://c.la2-c1cs-hnd.salesforceliveagent.com/content", //hardcode
	                    extraPrechatFormDetails:[]
	                    }
    	}else{
        	settings = {
        			env:"SIT",
                    //language:"zh_CN",//need to be set
                    channel:"Member Portal", //need to be set
                    membernumber:"AA-0000000346", //need to be set
                    orgId:"00DO00000053jxe", //hardcode
                    deploymentId:"572O0000000Cb7T", //hardcode
                    myDomainURL:"https://hkairportloyalty--sit.my.salesforce.com", //hardcode
                    communityURL:"https://sit-hkairportrewards.cs5.force.com/hkairportrewards", //hardcode
                    eswJSURL:"https://hkairportloyalty--sit.my.salesforce.com/embeddedservice/5.0/esw.min.js", //hardcode
                    gslbBaseURL:"https://service.force.com", //hardcode
                    baseLiveAgentURL:"https://d.la1-c1cs-hnd.salesforceliveagent.com/chat", //hardcode
                    baseLiveAgentContentURL:"https://c.la1-c1cs-hnd.salesforceliveagent.com/content", //hardcode
                    extraPrechatFormDetails:[]
                    }
    	}




        var e = window.event;                
        if(e.target.innerText == 'Lux'){ //need to be set to check which button clicked
            settings.buttonType = 'Luxury Reserve';//hardcode
        }else{
            settings.buttonType = 'General Enquiry'//hardcode
        }

        settings.language = document.getElementById("languageSelect").value;



        settings.extraPrechatFormDetails = [{"label": "Member Number","value": settings.membernumber,"displayToAgent": true},
                             {"label": "language","value": settings.language ,"displayToAgent": true, "transcriptFields": ["Preferred_Communication_Language__c"],},
                             {"label": "Chat Type","value": settings.buttonType,"displayToAgent": true, "transcriptFields": ["Type__c"],},
                             {"label": "Chat Channel","value": settings.channel,"displayToAgent": true, "transcriptFields": ["Channel__c"],}];         

        if (!window.embedded_svc) {
            var s = document.createElement('script');
            s.setAttribute('src', settings.eswJSURL);
            s.setAttribute('sandbox', 'allow-top-navigation allow-same-origin allow-forms allow-scripts');
            s.onload = function() {
                routeButton();
                initESW(null);
                
            };
            document.body.appendChild(s);
        } else {
                
            routeButton();
            embedded_svc.settings.language = document.getElementById("languageSelect").value ;
            embedded_svc.settings.directToButtonRouting = function() {
                    return settings.buttonId;
            }
            embedded_svc.onHelpButtonClick();

        }
    }

</script>
<select id="envSelect">
  <option value ="SIT">SIT</option>
  <option value="Dev">Dev</option>
</select>
<select id="languageSelect">
  <option value="en_US">en_US</option>
  <option value ="zh_CN">zh_CN</option>
  <option value ="zh_HK">zh_HK</option>
</select><br/><br/><br/>
<button type="button" onclick="checkAgentAvailable()">Lux</button>
<button type="button" onclick="checkAgentAvailable()">Gen</button>


    
</body>
</html>
